---
const { images = [], title = 'Галерея' } = Astro.props
const hasImages = Array.isArray(images) && images.length > 0
---

<section aria-label={title} class='gallery'>
	{
		hasImages && (
			<div class='gallery__scroller' role='list' data-gallery-scroller>
				{images.map((image, index) => (
					<button
						class='gallery__item'
						type='button'
						role='listitem'
						data-index={index}
						data-image-url={image.url}
						data-image-alt={image.alt ?? 'Изображение'}
					>
						<img
							src={image.url}
							alt={image.alt ?? 'Изображение'}
							loading='lazy'
						/>
					</button>
				))}
			</div>
		)
	}
</section>

<div class='gallery__overlay' id='gallery-overlay' aria-hidden='true'>
	<img class='gallery__overlay-image' id='overlay-image' src='' alt='' />
</div>

<style>
	.gallery__scroller {
		display: grid;
		grid-auto-flow: column;
		grid-auto-columns: minmax(200px, 30vw);
		gap: 1rem;
		overflow-x: auto;
		padding: 2rem;
		scrollbar-width: thin;
		mask-image: linear-gradient(90deg, #000 0%, #000 100%);
	}

	.gallery__scroller::-webkit-scrollbar {
		height: 6px;
	}

	.gallery__scroller::-webkit-scrollbar-thumb {
		background: rgba(255, 255, 255, 0.25);
		border-radius: 999px;
	}

	.gallery__scroller--has-left {
		mask-image: linear-gradient(90deg, transparent 0%, #000 4%, #000 100%);
	}

	.gallery__scroller--has-right {
		mask-image: linear-gradient(90deg, #000 0%, #000 96%, transparent 100%);
	}

	.gallery__scroller--has-left.gallery__scroller--has-right {
		mask-image: linear-gradient(
			90deg,
			transparent 0%,
			#000 4%,
			#000 96%,
			transparent 100%
		);
	}

	.gallery__item {
		all: unset;
		display: block;
		position: relative;
		border-radius: 14px;
		overflow: hidden;
		background: rgba(255, 255, 255, 0.06);
		scroll-snap-align: start;
		cursor: zoom-in;
		transition: box-shadow 0.3s ease;
	}

	.gallery__item:hover {
		box-shadow: 0 12px 25px rgba(0, 0, 0, 0.35);
		transform: translateY(-4px) scale(1.01);
	}

	.gallery__item img {
		display: block;
		width: 100%;
		height: 100%;
		aspect-ratio: 1 / 1;
		object-fit: cover;
		pointer-events: none;
	}

	.gallery__overlay {
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.9);
		backdrop-filter: blur(8px);
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 2rem;
		opacity: 0;
		visibility: hidden;
		transition:
			opacity 0.3s ease,
			visibility 0.3s ease;
		z-index: 10000;
		cursor: zoom-out;
	}

	.gallery__overlay[aria-hidden='false'] {
		opacity: 1;
		visibility: visible;
	}

	.gallery__overlay-image {
		max-width: 90vw;
		max-height: 90vh;
		object-fit: contain;
		border-radius: 8px;
		box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
	}

	@media (max-width: 720px) {
		.gallery__scroller {
			grid-auto-columns: minmax(180px, 75vw);
		}

		.gallery__overlay {
			padding: 1rem;
		}

		.gallery__overlay-image {
			max-width: 95vw;
			max-height: 80vh;
			border-radius: 12px;
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const scroller = document.querySelector(
			'[data-gallery-scroller]',
		) as HTMLElement | null
		const overlay = document.getElementById(
			'gallery-overlay',
		) as HTMLElement | null
		const overlayImage = document.getElementById(
			'overlay-image',
		) as HTMLImageElement | null

		if (!scroller || !overlay || !overlayImage) return

		// Update fade masks
		function updateMasks() {
			if (!scroller) return
			const scrollLeft = scroller.scrollLeft
			const maxScroll = scroller.scrollWidth - scroller.clientWidth

			scroller.classList.toggle('gallery__scroller--has-left', scrollLeft > 0.1)
			scroller.classList.toggle(
				'gallery__scroller--has-right',
				scrollLeft < maxScroll - 0.1,
			)
		}

		// Track scroll position
		scroller.addEventListener('scroll', updateMasks, { passive: true })
		updateMasks()

		// Open overlay on click
		const items = scroller.querySelectorAll('.gallery__item')
		items.forEach(function (item) {
			item.addEventListener('click', function () {
				const url = item.getAttribute('data-image-url')
				const alt = item.getAttribute('data-image-alt')

				if (!url || !overlayImage || !overlay) return

				overlayImage.src = url
				overlayImage.alt = alt || ''
				overlay.setAttribute('aria-hidden', 'false')
			})
		})

		// Close overlay
		function closeOverlay() {
			if (!overlay) return
			overlay.setAttribute('aria-hidden', 'true')
		}

		overlay.addEventListener('click', closeOverlay)

		// Close on escape key
		document.addEventListener('keydown', function (e) {
			if (!overlay) return
			if (
				e.key === 'Escape' &&
				overlay.getAttribute('aria-hidden') === 'false'
			) {
				closeOverlay()
			}
		})
	})
</script>
