---
import Layout from '../layouts/Layout.astro'
import ScrollGallery from '../components/ScrollGallery.astro'
import { UTApi } from 'uploadthing/server'
import Rules from '../components/Rules.astro'

let images: { url: string; alt: string }[] = []

const token = import.meta.env.UPLOADTHING_TOKEN
const appId = import.meta.env.UPLOADTHING_APP_ID
const ufsBaseUrl = import.meta.env.UPLOADTHING_UFS_URL

// Debug logging for build
console.log('Build env check:', {
	hasToken: !!token,
	hasAppId: !!appId,
	hasUfsUrl: !!ufsBaseUrl,
	tokenLength: token?.length || 0
})

if (token && (appId || ufsBaseUrl)) {
	try {
		const utapi = new UTApi({ token })
		const list = await utapi.listFiles({ limit: 40 })
		const baseUrl = ufsBaseUrl ?? `https://${appId}.ufs.sh`

		console.log(`Fetched ${list.files?.length || 0} images from UploadThing`)

		images = (list.files ?? [])
			.map((file) => {
				const key = file.key ?? file.id
				if (!key) return null
				return {
					url: `${baseUrl}/f/${key}`,
					alt: file.name ?? file.customId ?? 'Изображение',
				}
			})
			.filter((item): item is { url: string; alt: string } => item !== null)

		console.log(`Processed ${images.length} valid images`)
	} catch (error) {
		console.error('UploadThing fetch failed:', error)
	}
} else {
	console.warn('Missing UploadThing credentials - skipping image fetch')
}
---

<Layout>
	<Rules />
	<ScrollGallery images={images} />
</Layout>
